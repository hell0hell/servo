/****************************************************************************************************/
/*																									*/
/*																									*/
/*		MsgMngr.c : Message Manager																	*/
/*																									*/
/*																									*/
/****************************************************************************************************/
/*																									*/
/*		1) Message Interace																			*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/************** Copyright (C) Yaskawa Electric Corporation ******************************************/
/*																									*/
/*		Rev.1.00 : 2013.04.18  K.Ozaki																*/
/*		Rev.1.10 : 2013.08.08  K.Ozaki		@@Panel Operator										*/
/*																									*/
/*																									*/
/*																									*/
/****************************************************************************************************/
#include "KnlApi.h"								/* Kernel API */


/****************************************************************************************************/
/*																									*/
/*		関数一覧																					*/
/*																									*/
/****************************************************************************************************/
void KpxMsgManager(void);							/* Message Manager Main Function				*/


/*--------------------------------------------------------------------------------------------------*/
static void	LpxSerialMsgManager( HMSGIF hmsg );				/* シリアルメッセージ管理				*/
static void	LpxInitMsgInterface( void );					/* メッセージＩＦ初期化処理				*/
/*--------------------------------------------------------------------------------------------------*/
static LONG	LpxCheckRecvMessage( HMSGIF Hmsg );		/* Check Received Message						*/
LONG	RkiMsgifGetCmdMsgLength( UCHAR *CmdBuf, LONG CmdBufLen ); /*							*/
/*--------------------------------------------------------------------------------------------------*/

/*--------------------------------------------------------------------------------------------------*/
/*		Macro Functions																				*/
/*--------------------------------------------------------------------------------------------------*/
/* <boot> >>>>> */
#ifndef NULL
#define NULL	0
#endif
#define USBIF_N_CH	1
#define COM0_USB	0
/* <<<<< <boot> */


/****************************************************************************************************/
/*																									*/
/*		Variables Definition																		*/
/*																									*/
/****************************************************************************************************/

/*--------------------------------------------------------------------------------------------------*/
/*	Message I/F																						*/
/*--------------------------------------------------------------------------------------------------*/
MSGIF	UsbMsg[USBIF_N_CH];						/* USB Message I/F 									*/
/*--------------------------------------------------------------------------------------------------*/

extern CSIF USif[USBIF_N_CH];
/****************************************************************************************************/
/*																									*/
/*		メッセージ管理																				*/
/*																									*/
/****************************************************************************************************/
void KpxMsgManager(void)
{
	LpxSerialMsgManager( &UsbMsg[COM0_USB] );
}

/****************************************************************************************************/
/*																									*/
/*		シリアルメッセージ管理																		*/
/*																									*/
/****************************************************************************************************/
/*																									*/
/*	機 能 : シリアルメッセージの受信を監視し、各シリアルメッセージ処理(LcdOp,SigmaMsg,etc)			*/
/*			の実行制御を行う。																		*/
/*																									*/
/*																									*/
/*																									*/
/****************************************************************************************************/
void	LpxSerialMsgManager( HMSGIF Hmsg )
{
	CSIF *Sif = Hmsg->Sif;
/*--------------------------------------------------------------------------------------------------*/
		if( Sif == NULL ) { return; }								/* No Serial Interface 			*/
/*--------------------------------------------------------------------------------------------------*/
/*		メッセージ受信完時																			*/
/*--------------------------------------------------------------------------------------------------*/
		if( Sif->ChkCmd( Sif, &(Hmsg->CmdMsgLen) ) )
		{
		/*------------------------------------------------------------------------------------------*/
		/*	受信メッセージ正常																		*/
		/*------------------------------------------------------------------------------------------*/
			if( LpxCheckRecvMessage( Hmsg ) != OK )					/* check message */
			{
				Sif->StxRes( Sif, Hmsg->ResBuf, 0 );				/* no response */
			}
		/*------------------------------------------------------------------------------------------*/
		/*	Serial Message Procedure (SigmaWin, etc)												*/
		/*------------------------------------------------------------------------------------------*/
			else
			{
				Hmsg->ComMode = SCM_MSGCOM;							/* Update ComMode				*/
				KpiRstLongTimer( &(Hmsg->ComChkTime) );				/* Reset ComChkTimer			*/
				RpxMsgifMainProcedure( Hmsg );						/* Call MsgIf Main Procedure	*/
			}
		}
/*--------------------------------------------------------------------------------------------------*/
/*		メッセージ受信未完時 : Check Timeout														*/
/*--------------------------------------------------------------------------------------------------*/
		else
		{
			switch( Hmsg->ComMode )										/* Check ComMode			*/
			{
			case SCM_MSGCOM:											/* Serial Message Mode		*/
				 if( KpiGetLongTimer( &(Hmsg->ComChkTime) ) > 20000 )	/* Check Timeout 20sec		*/
				 {
//					RpxMsgifFinishProcedure( Hmsg );					/* Finish SifMsg			*/
					Hmsg->ComMode = SCM_NOCOM;							/* Update ComMode			*/
				 }
				 break;
			default:
				 break;
			}
		}
/*--------------------------------------------------------------------------------------------------*/
		return;
}


/****************************************************************************************************/
/*																									*/
/*		メッセージＩＦ初期化処理																	*/
/*																									*/
/****************************************************************************************************/
void KpxInitMsgInterface( void )
{
		LpxInitMsgInterface( );
}


/****************************************************************************************************/
/*																									*/
/*		メッセージＩＦ初期化処理																	*/
/*																									*/
/****************************************************************************************************/
void	LpxInitMsgInterface( void )
{

/*--------------------------------------------------------------------------------------------------*/
/*		USBメッセージＩＦ初期化																		*/
/*--------------------------------------------------------------------------------------------------*/
		KRI_INIT_MSGIF( &UsbMsg[COM0_USB], &USif[COM0_USB] );	/* init com I/F (USB ch:0)			*/
		KRI_SET_FLG_USBMSG( &UsbMsg[COM0_USB] );				/* set sif message flag				*/

		return;
}


/****************************************************************************************************/
/*																									*/
/*		MessageI/F : 受信メッセージチェック															*/
/*																									*/
/****************************************************************************************************/
/*																									*/
/*	機 能 : 受信メッセージのチェックを行う。														*/
/*																									*/
/*			1) 受信メッセージ長のチェック															*/
/*			2) 受信メッセージのサムチェック															*/
/*			3) 軸アドレスのチェック(MEMOBUS)														*/
/*																									*/
/*																									*/
/****************************************************************************************************/
LONG	LpxCheckRecvMessage( HMSGIF Hmsg )
{
LONG	MsgLen = Hmsg->CmdMsgLen = RkiMsgifGetCmdMsgLength( Hmsg->CmdBuf, Hmsg->RcvBufSize );		
		if( MsgLen <= 0 ){  return (NG); } /* wrong message */
/*--------------------------------------------------------------------------------------------------*/
/*		SigmaMemobus (PC, etc)																		*/
/*--------------------------------------------------------------------------------------------------*/
		return MlibChkCRC16MB( Hmsg->CmdBuf, MsgLen );
}

/****************************************************************************************************/
/*																									*/
/*		MessageI/F : 指令メッセージ長取得(for Kernel\Driver\SifMbus.c)								*/
/*																									*/
/****************************************************************************************************/
#define LPX_GET_CMDMSGLEN( i, Mul, Add )\
		if( CmdBufLen < (i+2) ){ return( 0 );}\
		else{ return( (((CmdBuf[i]<<8) + CmdBuf[i+1]) * Mul) + Add );}
#define LPX_CHK_SLOT( SfcH )			(SfcH == 0x01)
#define LPX_GET_SLOT_BYTELEN( SfcH )	((LPX_CHK_SLOT( SfcH ))? 2 : 0)
/*--------------------------------------------------------------------------------------------------*/
LONG	RkiMsgifGetCmdMsgLength( UCHAR *CmdBuf, LONG CmdBufLen )
{
LONG	s = LPX_GET_SLOT_BYTELEN( CmdBuf[2] );
LONG	Offset;											/* <S150> */
/*--------------------------------------------------------------------------------------------------*/
/*		Check CmdBufLen																				*/
/*--------------------------------------------------------------------------------------------------*/
		if( CmdBufLen < 4 )
		{
			return( 0 );								/* CmdBufLen is Short						*/
		}
/*--------------------------------------------------------------------------------------------------*/
/*		Check Function Code and Calculate CmdMsgLen													*/
/*--------------------------------------------------------------------------------------------------*/
		switch( CmdBuf[1] )
		{
		case MFC_LOOPBACK:
			 return( 8 );
		case MFC_SVXMSG16:
			 switch( CmdBuf[3] )
			 {
			 case SFC_RD_ONEREG: return(  8 + s );
			 case SFC_WR_ONEREG: return( 10 + s );
			 case SFC_RD_SEQREG: return( 10 + s );
			 case SFC_WR_SEQREG: LPX_GET_CMDMSGLEN( 6 + s, 2, 12 + s );
			 case SFC_RD_RANREG: LPX_GET_CMDMSGLEN( 4 + s, 2,  8 + s );
			 case SFC_WR_RANREG: LPX_GET_CMDMSGLEN( 4 + s, 4, 10 + s );
			 case SFC_RD_MAXNUM: return(  8 + s );
			 default: return( -1 );
			 }
//			 return( -1 );//<S0C7>statement is unreachable
		case MFC_SYSDWNLD:								/* @@@ Add Later @@@						*/
			 return( MbusFuncSysDLGetMsgLength(CmdBuf) );
		default:
			 return( -1 );
		}
/*--------------------------------------------------------------------------------------------------*/
		/* unreachable return( -1 );  */				/* Unknown Function Code					*/
}

/***************************************** end of file **********************************************/
