/****************************************************************************************************/
/*																									*/
/*																									*/
/*		VirSif.c : Virtual Serial Interface															*/
/*																									*/
/*																									*/
/****************************************************************************************************/
/*																									*/
/*	Function : Virtual Serial Interface																*/
/*																									*/
/*			1) 																						*/
/*			2) 																						*/
/*			3) 																						*/
/*			4) 																						*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/*																									*/
/************** Copyright (C) Yaskawa Electric Corporation ******************************************/
/*																									*/
/*																									*/
/*		Rev.1.xx : 2013.8.10	K.Ozaki																*/
/*																									*/
/*																									*/
/****************************************************************************************************/
#include	"KnlApi.h"


#if 	SVFSEL_VIRSIF_USE == 1
/****************************************************************************************************/
/*																									*/
/*		Function Prototypes																			*/
/*																									*/
/****************************************************************************************************/
/*--------------------------------------------------------------------------------------------------*/
/*		Public Functions																			*/
/*--------------------------------------------------------------------------------------------------*/
void	KpxVirSifManager( void );			/* Virtual Serial Message Interface Manager				*/
void	KpxInitVirSifManager( 				/* Initialize Virtual Serial Message Interface 			*/
				LONG ch,	 				/* VUART channel number (0,1,2)							*/
				LONG axis );				/* VUART axis number (0,1,2)							*/

/*--------------------------------------------------------------------------------------------------*/
/*		Private Functions : Panel Interface															*/
/*--------------------------------------------------------------------------------------------------*/
void	LpiVirSifPanelManager( CSIF *this );		/* Panel Operator Manager						*/
/*--------------------------------------------------------------------------------------------------*/
LONG	LpiCheckRxPanelMsg( 						/* Panel message receive complete check API 	*/
		CSIF *this,									/* serial I/F class pointer						*/
		USHORT *pCmdMsgLen );						/* pointer to the command message lentgh		*/
/*--------------------------------------------------------------------------------------------------*/
LONG	LpiStartTxPanelMsg(							/* Panel message start transmit request API		*/
		CSIF	*this,								/* serial I/F class pointer						*/
		UCHAR*	TxBuf,								/* transmit response buffer						*/
		LONG	TxSize		);						/* transmit message size						*/
/*--------------------------------------------------------------------------------------------------*/
void	LpxVirSifGetPnlBtn( CSIF *this );			/* TODO: Get Panel Button 						*/
void	LpxVirSifSetPnlLed( CSIF *this );			/* TODO: Set Panel LED 							*/
/*--------------------------------------------------------------------------------------------------*/

/****************************************************************************************************/
/*																									*/
/*		Variables																					*/
/*																									*/
/****************************************************************************************************/
/*--------------------------------------------------------------------------------------------------*/
CSIF	VSif[VSIF_N_CH];					/* Virtual Serial Communication Management IF Class		*/
/*--------------------------------------------------------------------------------------------------*/

/****************************************************************************************************/
/*																									*/
/*		Constant Definition																			*/
/*																									*/
/****************************************************************************************************/
/*--------------------------------------------------------------------------------------------------*/
#define	VSIFREQ_STARTTX		(0x01)			/* Start transmit request								*/
#define	VSIFREQ_NOANSWER	(0x02)			/* no response 											*/
/*--------------------------------------------------------------------------------------------------*/
#define VSIF_PNL_RXWAITTIME (100)   		/* Rx Wait Time : 100ms 								*/
#define VSIF_PNL_TXWAITTIME (0)   			/* Tx Wait Time : 0ms 									*/
/*--------------------------------------------------------------------------------------------------*/

/****************************************************************************************************/
/*																									*/
/*		Initialize Virtual Serial Message Interface													*/
/*																									*/
/****************************************************************************************************/
void	KpxInitVirSifManager( LONG ch, LONG Axis )
{
CSIF *pSif = &(VSif[ch]);										/* get serial IF pointer 			*/
/*--------------------------------------------------------------------------------------------------*/
	MlibResetLongMemory( pSif, sizeof( CSIF )/4 );				/* reset data	*/
/*--------------------------------------------------------------------------------------------------*/
	pSif->Com = NULL; 											/* set com port */
	pSif->AxisNumber = Axis;									/* set axis number */
/*--------------------------------------------------------------------------------------------------*/
	switch( ch )
	{
/*--------------------------------------------------------------------------------------------------*/
	case VCOM0_PANEL:											/* 0: Panel Operator 				*/
/*--------------------------------------------------------------------------------------------------*/
		pSif->DoRxTx = LpiVirSifPanelManager;					/* panel message sequence */
		pSif->ChkCmd = LpiCheckRxPanelMsg;						/* check panel message cmd method */
		pSif->StxRes = LpiStartTxPanelMsg;						/* start tx panel response method */
		pSif->RcvBufSize = SIF_RX_BUFSIZE;						/* rcv buf size */
		pSif->SndBufSize = SIF_TX_BUFSIZE;						/* send buf size */
		break;
	default:
		break;
	}
/*--------------------------------------------------------------------------------------------------*/
	return;
}

/****************************************************************************************************/
/*																									*/
/*		Virtual Serial Message Manager( ScanC Cycle )												*/
/*																									*/
/****************************************************************************************************/
void	KpxVirSifManager( void )
{
	if( SVFSEL_PANELOP_USE == 1) { VSif[VCOM0_PANEL].DoRxTx( &(VSif[VCOM0_PANEL]) ); /* ch0: Panel */ }
	return;
}


/****************************************************************************************************/
/*																									*/
/*		Panel Message Cyclic Sequence																*/
/*																									*/
/****************************************************************************************************/
enum	SQSTEP	{
	SQSTEP_PNL_INITIAL = 0,
	SQSTEP_PNL_WAITRX,
	SQSTEP_PNL_WAITSTX,
};
/*--------------------------------------------------------------------------------------------------*/
void	LpiVirSifPanelManager( CSIF *this )
{
USHORT	timer;
/*--------------------------------------------------------------------------------------------------*/
/*		Panel Operator Message Sequence 															*/
/*--------------------------------------------------------------------------------------------------*/
		switch( this->SqStep )
		{
/*--------------------------------------------------------------------------------------------------*/
		case SQSTEP_PNL_INITIAL: 	/* 0: Initial Step												*/
/*--------------------------------------------------------------------------------------------------*/
			this->ReqStx = 0x00;                        /* reset Tx request							*/
			KpiRstLongTimer( &(this->RxTimer) );		/* Reset RxTimer							*/
			this->SqStep = SQSTEP_PNL_WAITRX;           /* wait Rx 									*/
			break;
/*--------------------------------------------------------------------------------------------------*/
		case SQSTEP_PNL_WAITRX: 	/* 1: Wait Receive Message										*/
/*--------------------------------------------------------------------------------------------------*/
			timer = KpiGetLongTimer( &(this->RxTimer) );	/* get RxTimer							*/
			if( timer >= VSIF_PNL_RXWAITTIME )
			{
				LpxVirSifGetPnlBtn( this );					/* Get Btn input						*/
				this->SqStep = SQSTEP_PNL_WAITSTX;			/* wait start transmit message 			*/
			}
			break;
/*--------------------------------------------------------------------------------------------------*/
		case SQSTEP_PNL_WAITSTX:	/* 2: Wait Start Transmit Message								*/
/*--------------------------------------------------------------------------------------------------*/
			if( this->ReqStx == VSIFREQ_STARTTX	)			/* check start request					*/
			{
				this->ReqStx  = 0x00;						/* Reset ReqStx							*/
				LpxVirSifSetPnlLed( this );					/* Set Led Output 						*/
				this->SqStep  = SQSTEP_PNL_INITIAL;			/* Initial Step							*/
			}
			break;
/*--------------------------------------------------------------------------------------------------*/
		default:
/*--------------------------------------------------------------------------------------------------*/
			break;
		}
/*--------------------------------------------------------------------------------------------------*/
	return;
}



/****************************************************************************************************/
/*																									*/
/*		Panel message receive complete check API 													*/
/*																									*/
/*			return: receive complete 						: TRUE									*/
/*					not received 							: FALSE									*/
/*																									*/
/*																									*/
/****************************************************************************************************/
LONG	LpiCheckRxPanelMsg( CSIF *this, USHORT *pCmdMsgLen )
{
/*--------------------------------------------------------------------------------------------------*/
/*		receive complete																			*/
/*--------------------------------------------------------------------------------------------------*/
		if( this->SqStep == SQSTEP_PNL_WAITSTX )
		{
			*pCmdMsgLen = sizeof( PNLCMDMSG );
			return( TRUE );
		}
/*--------------------------------------------------------------------------------------------------*/
/*		not received																				*/
/*--------------------------------------------------------------------------------------------------*/
		return( FALSE );
}


/****************************************************************************************************/
/*																									*/
/*		Panel message start transmit request API													*/
/*																									*/
/*			return:																					*/
/*						(1) start transmit															*/
/*						(0) error sequence															*/
/*																									*/
/*																									*/
/****************************************************************************************************/
LONG	LpiStartTxPanelMsg(							/* Panel message start transmit request API		*/
		CSIF	*this,								/* serial I/F class pointer						*/
		UCHAR*	TxBuf,								/* transmit response buffer						*/
		LONG	TxSize		)						/* transmit message size						*/
{
/*--------------------------------------------------------------------------------------------------*/
		if( this->SqStep != SQSTEP_PNL_WAITSTX )	/* check sequence								*/
		{
			return( FALSE );						/* sequence error								*/
		}
		else 
		{
			this->pTxRes   = TxBuf;					/* set tx buffer address						*/
			this->TxResLen = (USHORT)TxSize;		/* set tx message size							*/
			this->ReqStx   = VSIFREQ_STARTTX;		/* start tx request								*/
			return( TRUE );
		}
/*--------------------------------------------------------------------------------------------------*/
}




/****************************************************************************************************/
/*
 * 		Get Panel Button Function
 *
 *
 */
/****************************************************************************************************/
void	LpxVirSifGetPnlBtn( CSIF *this )
{
ULONG	InSig;
UCHAR	*CmdBuf  = this->RxBuf;
/*--------------------------------------------------------------------------------------------------*/
/*		Get Button 																					*/
/*--------------------------------------------------------------------------------------------------*/
		InSig = HALdrv_ReadInputSignals().dw;								/* get input signals	*/
		CmdBuf[PNLCMD_PNLBTN_IDX] = (UCHAR)(((InSig >> 16) ^ 0x0F) & 0x0F);	/* get panel button 	*/
/*--------------------------------------------------------------------------------------------------*/
		return;

}

/****************************************************************************************************/
/*																									*/
/* 		Set Panel Led Function																		*/
/*																									*/
/*																									*/
/*																									*/
/****************************************************************************************************/
void	LpxVirSifSetPnlLed( CSIF *this )
{
ULONG	OutSig;
UCHAR	*ResBuf  = this->TxBuf;
/*--------------------------------------------------------------------------------------------------*/
/*		Set Led 																					*/
/*--------------------------------------------------------------------------------------------------*/
		HALdrv_TstSetPnlLedC( &(ResBuf[PNLRSP_LEDCODE_IDX]) );
/*--------------------------------------------------------------------------------------------------*/
		return;

}



#endif /* SVFSEL_VIRSIF_USE == 1 */
/***************************************** end of file **********************************************/
